--source include/windows.inc
--source include/check_utf8_cli.inc

# Test for password-codepage, non-ASCII password
# We emulate creating password in an interactive client session, for older clients
# which communicates with the server using with something like cp850

perl;
  use autodie;
  open(OUT, '>', "$ENV{MYSQLTEST_VARDIR}/tmp/create_user_cp850.sql");
  # Write CREATE USER 'u' IDENTIFIED by 'ü', in cp850
  binmode OUT;
  print OUT "CREATE USER 'u' IDENTIFIED by '\x81';\n";
  close OUT;
EOF

exec $MYSQL --default-character-set=cp850 < $MYSQLTEST_VARDIR/tmp/create_user_cp850.sql;
remove_file $MYSQLTEST_VARDIR/tmp/create_user_cp850.sql;

# Can't login with using --password on the command line
# but the problem exists everywhere else, since password on the command line is passed using
# ANSI codepage, which is neither cp437 or cp850.
# Note that --default-character-set, or chcp does not help, client uses command line arguments
# as-is, no conversion
error 1;
exec $MYSQL --default-character-set=cp850 --user=u --password=ü  -e "do 1";

# Now --password-codepage does help
exec $MYSQL --user=u --password=ü --password-codepage=oem -e "do 1";
exec $MYSQL --user=u --password=ü --password-codepage=850 -e "do 1";


# Create a config file, where password is written using the same *bytes*
# as in the original query.
# One would probably need a  hex editor for such config file
# But, as we check later, the login would work.
perl;
  open(OUT, '>', "$ENV{MYSQLTEST_VARDIR}/tmp/passwd.cnf");
  binmode OUT;
  print OUT "[client]\npassword=\x81\n";
  close OUT;
EOF

# 'Binary' config file should also help
exec $EXE_MYSQL --defaults-file=$MYSQLTEST_VARDIR/tmp/passwd.cnf  --port=$MASTER_MYPORT --protocol=tcp --user=u -e "do 1";

# Test warnings in the output

# Invalid codepage number
error 1;
exec $MYSQL --default-character-set=cp850 --user=u --password=ü --password-codepage=0 -e "do 1" 2>&1;

# Invalid codepage, not numeric
error 1;
exec $MYSQL --default-character-set=cp850 --user=u --password=ü --password-codepage=bla -e "do 1" 2>&1;

# Unconvertible to password codepage characters ("lost in translation")
error 1;
exec $MYSQL --default-character-set=cp850 --user=u --password=пароль --password-codepage=850 -e "do 1" 2>&1;

DROP user u;
